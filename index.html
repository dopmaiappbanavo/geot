<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>GeoSnap Pro - Precision Camera</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        :root {
            --brand-color: #ee6912;
            --safe-top: env(safe-area-inset-top);
            --safe-bottom: env(safe-area-inset-bottom);
        }

        body {
            background-color: #000;
            color: #ffffff;
            margin: 0;
            padding: 0;
            overflow: hidden;
            width: 100vw;
            height: 100dvh;
            font-family: 'Inter', -apple-system, sans-serif;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
            overscroll-behavior-y: contain;
            touch-action: manipulation;
        }

        /* Fullscreen Layout */
        #app-wrapper {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        #camera-container {
            position: absolute;
            inset: 0;
            z-index: 1;
            background: #000;
        }

        video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* Top Overlay UI */
        .top-bar {
            position: absolute;
            top: var(--safe-top);
            left: 0;
            right: 0;
            z-index: 10;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(to bottom, rgba(0,0,0,0.5), transparent);
        }

        .icon-btn {
            color: white;
            font-size: 20px;
            opacity: 0.9;
            transition: opacity 0.2s;
            background: none;
            border: none;
            padding: 8px;
        }

        /* Professional Geo Stamp */
        .geo-stamp-overlay {
            position: absolute;
            bottom: 160px;
            left: 20px;
            right: 20px;
            z-index: 10;
            pointer-events: none;
        }

        .stamp-card {
            background: rgba(0, 0, 0, 0.65);
            backdrop-filter: blur(12px);
            border-radius: 12px;
            padding: 10px;
            display: flex;
            gap: 12px;
            width: fit-content;
            max-width: 90%;
            border: 1px solid rgba(255,255,255,0.1);
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            animation: slideUp 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .mini-map {
            width: 70px;
            height: 70px;
            border-radius: 8px;
            background: #222;
            overflow: hidden;
            flex-shrink: 0;
        }

        .mini-map img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .stamp-details {
            display: flex;
            flex-direction: column;
            justify-content: center;
            color: white;
        }

        .location-main { font-weight: 700; font-size: 14px; margin-bottom: 2px; }
        .location-sub { font-size: 12px; opacity: 0.9; margin-bottom: 4px; }
        .coords-text { font-family: monospace; font-size: 10px; opacity: 0.7; }

        /* Bottom Controls */
        .bottom-bar {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 140px;
            z-index: 10;
            display: flex;
            align-items: center;
            justify-content: space-around;
            padding-bottom: var(--safe-bottom);
            background: linear-gradient(to top, rgba(0,0,0,0.8), transparent);
        }

        .shutter-btn {
            width: 76px;
            height: 76px;
            border-radius: 50%;
            border: 4px solid white;
            background: rgba(255,255,255,0.2);
            padding: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .shutter-inner {
            width: 100%;
            height: 100%;
            background: white;
            border-radius: 50%;
            transition: transform 0.1s;
        }

        .shutter-btn:active .shutter-inner { transform: scale(0.85); }

        .nav-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            color: white;
            background: none;
            border: none;
        }

        .nav-btn span { font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }

        #preview-layer {
            position: fixed;
            inset: 0;
            background: #000;
            z-index: 100;
            display: none;
            flex-direction: column;
        }

        .brand-color { color: var(--brand-color); }
        .brand-bg { background-color: var(--brand-color); }
    </style>
</head>
<body>

    <div id="app-wrapper">
        <!-- Top Toolbar -->
        <div class="top-bar">
            <button class="icon-btn"><i class="fa-regular fa-image"></i></button>
            <button class="icon-btn" onclick="toggleFlash()"><i class="fa-solid fa-bolt-lightning"></i></button>
            <button class="icon-btn" onclick="flipCamera()"><i class="fa-solid fa-camera-rotate"></i></button>
            <button class="icon-btn"><i class="fa-solid fa-sliders"></i></button>
            <button class="icon-btn"><i class="fa-solid fa-gear"></i></button>
        </div>

        <!-- Main Camera View -->
        <div id="camera-container">
            <video id="video-feed" autoplay playsinline muted></video>
        </div>

        <!-- Live Stamp -->
        <div class="geo-stamp-overlay">
            <div id="stamp-card" class="stamp-card">
                <div class="mini-map">
                    <img id="stamp-map" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mP8/5+hHgAHggJ/PchI7wAAAABJRU5ErkJggg==" alt="Map">
                </div>
                <div class="stamp-details">
                    <div id="stamp-country" class="location-main">Detecting...</div>
                    <div id="stamp-province" class="location-sub">Acquiring Location</div>
                    <div id="stamp-latlong" class="coords-text">Lat: 0.0000, Long: 0.0000</div>
                    <div id="stamp-datetime" class="coords-text">--/--/-- --:-- --</div>
                </div>
            </div>
        </div>

        <!-- Bottom Shutter & Navigation -->
        <div class="bottom-bar">
            <button class="nav-btn">
                <i class="fa-solid fa-stamp text-xl mb-1"></i>
                <span>Stamp</span>
            </button>
            
            <button class="shutter-btn" onclick="capture()">
                <div class="shutter-inner"></div>
            </button>

            <button class="nav-btn">
                <div class="w-8 h-8 rounded-full overflow-hidden border border-white/40 mb-1">
                    <img id="recent-thumb" src="https://via.placeholder.com/100" class="w-full h-full object-cover">
                </div>
                <span>My Photos</span>
            </button>
        </div>

        <!-- Fullscreen Capture Splash -->
        <div id="shutter-flash" class="fixed inset-0 bg-white z-[60] opacity-0 pointer-events-none transition-opacity duration-150"></div>
    </div>

    <!-- Preview/Result Modal -->
    <div id="preview-layer">
        <div class="flex-1 relative overflow-hidden flex items-center justify-center">
            <canvas id="result-canvas" class="max-w-full max-h-full object-contain"></canvas>
        </div>
        <div class="h-32 bg-white flex items-center justify-between px-10">
            <button onclick="closePreview()" class="text-gray-500 font-bold uppercase text-xs flex flex-col items-center gap-1">
                <i class="fa-solid fa-xmark text-xl"></i> Cancel
            </button>
            <button onclick="saveFinal()" class="brand-bg text-white px-8 py-3 rounded-full font-bold flex items-center gap-2 shadow-lg">
                <i class="fa-solid fa-download"></i> SAVE PHOTO
            </button>
        </div>
    </div>

    <script>
        const video = document.getElementById('video-feed');
        const canvas = document.getElementById('result-canvas');
        const apiKey = ""; // Provided by environment
        let currentCoords = null;
        let addressInfo = { country: "Searching...", province: "Locating..." };
        let facingMode = 'environment';

        // --- Core Init ---
        async function initCamera() {
            try {
                if(video.srcObject) {
                    video.srcObject.getTracks().forEach(t => t.stop());
                }
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode, width: { ideal: 1920 }, height: { ideal: 1080 } },
                    audio: false
                });
                video.srcObject = stream;
            } catch (err) {
                console.error("Camera failed:", err);
            }
        }

        function startLocation() {
            navigator.geolocation.watchPosition(async (pos) => {
                const needsUpdate = !currentCoords || 
                    Math.abs(currentCoords.latitude - pos.coords.latitude) > 0.001;
                
                currentCoords = pos.coords;
                updateUI();
                
                if (needsUpdate) {
                    reverseGeocode(pos.coords.latitude, pos.coords.longitude);
                    updateMap(pos.coords.latitude, pos.coords.longitude);
                }
            }, null, { enableHighAccuracy: true });
        }

        // --- Gemini Geocoding ---
        async function reverseGeocode(lat, lng) {
            const prompt = `Identify the Country and the specific State/Province for these coordinates: ${lat}, ${lng}. Return strictly JSON like: {"country": "...", "province": "..."}`;
            
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }],
                        generationConfig: { responseMimeType: "application/json" }
                    })
                });
                const data = await response.json();
                const result = JSON.parse(data.candidates[0].content.parts[0].text);
                addressInfo = result;
                updateUI();
            } catch (e) {
                addressInfo = { country: "Unknown Location", province: "GPS Active" };
            }
        }

        function updateMap(lat, lng) {
            // Using OpenStreetMap static tile (Free/Public)
            const zoom = 15;
            const mapImg = document.getElementById('stamp-map');
            mapImg.src = `https://static-maps.yandex.ru/1.x/?lang=en_US&ll=${lng},${lat}&z=${zoom}&l=map&size=200,200`;
        }

        function updateUI() {
            if (!currentCoords) return;
            document.getElementById('stamp-country').textContent = addressInfo.country;
            document.getElementById('stamp-province').textContent = addressInfo.province;
            document.getElementById('stamp-latlong').textContent = `Lat: ${currentCoords.latitude.toFixed(6)}, Long: ${currentCoords.longitude.toFixed(6)}`;
            
            const now = new Date();
            const dateStr = now.toLocaleDateString('en-GB');
            const timeStr = now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true });
            document.getElementById('stamp-datetime').textContent = `${dateStr} ${timeStr}`;
        }

        // --- Camera Actions ---
        function flipCamera() {
            facingMode = facingMode === 'user' ? 'environment' : 'user';
            initCamera();
        }

        function toggleFlash() {
            const track = video.srcObject.getVideoTracks()[0];
            const caps = track.getCapabilities();
            if (caps.torch) {
                const current = track.getSettings().torch;
                track.applyConstraints({ advanced: [{ torch: !current }] });
            }
        }

        async function capture() {
            // UI Flash effect
            const flash = document.getElementById('shutter-flash');
            flash.style.opacity = '1';
            setTimeout(() => flash.style.opacity = '0', 150);

            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const ctx = canvas.getContext('2d');
            
            // 1. Draw Main Image
            ctx.drawImage(video, 0, 0);

            // 2. Draw Stamp Card (Composite)
            const stampW = canvas.width * 0.45;
            const stampH = canvas.height * 0.12;
            const margin = 50;
            const radius = 24;

            // Draw Card Background
            ctx.fillStyle = 'rgba(0,0,0,0.7)';
            ctx.beginPath();
            ctx.roundRect(margin, canvas.height - stampH - margin - 150, stampW, stampH, radius);
            ctx.fill();

            // Draw Map Image on Canvas
            const mapImg = document.getElementById('stamp-map');
            ctx.save();
            ctx.beginPath();
            ctx.roundRect(margin + 20, canvas.height - stampH - margin - 130, stampH - 40, stampH - 40, 10);
            ctx.clip();
            ctx.drawImage(mapImg, margin + 20, canvas.height - stampH - margin - 130, stampH - 40, stampH - 40);
            ctx.restore();

            // Draw Text
            ctx.fillStyle = 'white';
            const textX = margin + stampH;
            const baseLine = canvas.height - stampH - margin - 100;
            
            ctx.font = 'bold 36px sans-serif';
            ctx.fillText(addressInfo.country, textX, baseLine);
            
            ctx.font = '30px sans-serif';
            ctx.fillText(addressInfo.province, textX, baseLine + 40);
            
            ctx.fillStyle = 'rgba(255,255,255,0.7)';
            ctx.font = '22px monospace';
            const latLong = `Lat: ${currentCoords.latitude.toFixed(6)}, Long: ${currentCoords.longitude.toFixed(6)}`;
            ctx.fillText(latLong, textX, baseLine + 80);
            ctx.fillText(document.getElementById('stamp-datetime').textContent, textX, baseLine + 110);

            // Update thumb and show preview
            document.getElementById('recent-thumb').src = canvas.toDataURL();
            document.getElementById('preview-layer').style.display = 'flex';
        }

        function closePreview() {
            document.getElementById('preview-layer').style.display = 'none';
        }

        function saveFinal() {
            const link = document.createElement('a');
            link.download = `GeoSnap_${Date.now()}.jpg`;
            link.href = canvas.toDataURL('image/jpeg', 0.95);
            link.click();
            closePreview();
        }

        window.onload = () => {
            initCamera();
            startLocation();
        };
    </script>
</body>
</html>
