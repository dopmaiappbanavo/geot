<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="theme-color" content="#ffffff">
    <title>GeoCam Pro</title>
    
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="data:application/json;base64,ewogICJnameIjogIkdlb0NhbSBQcm8iLAogICJzaG9ydF9uYW1lIjogIkdlb0NhbSIsCiAgInN0YXJ0X3VybCI6ICIuIiwKICAmZGlzcGxheSI6ICJzdGFuZGFsb25lIiwKICAiYmFja2dyb3VuZF9jb2xvciI6ICIjZmZmZmZmIiwKICAidGhlbWVfY29sb3IiOiAiI2ZmZmZmZiIsCiAgIm9yaWVudGF0aW9uIjogInBvcnRyYWl0Igp9">

    <style>
        /* --- NATIVE APP RESET (WHITE THEME) --- */
        :root {
            --bg-color: #ffffff;
            --surface-color: #f8f9fa;
            --primary-color: #2563eb;
            --accent-color: #059669;
            --text-color: #111827;
            --border-color: #e5e7eb;
            --safe-area-inset-top: env(safe-area-inset-top, 0px);
            --safe-area-inset-bottom: env(safe-area-inset-bottom, 0px);
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
            -webkit-user-select: none;
        }

        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background-color: var(--bg-color);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            color: var(--text-color);
            overscroll-behavior: none;
        }

        body {
            display: flex;
            flex-direction: column;
            touch-action: none;
        }

        /* --- UI COMPONENTS --- */
        header {
            height: calc(60px + var(--safe-area-inset-top));
            padding-top: var(--safe-area-inset-top);
            background-color: var(--bg-color);
            display: flex;
            align-items: center;
            justify-content: center;
            border-bottom: 1px solid var(--border-color);
            z-index: 100;
        }

        header h1 {
            font-size: 1rem;
            font-weight: 700;
            letter-spacing: 0.5px;
            margin: 0;
            text-transform: uppercase;
            color: var(--text-color);
        }

        #app-container {
            flex: 1;
            position: relative;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Camera Viewport */
        #camera-wrapper {
            flex: 1;
            position: relative;
            background: #000;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        #camera-preview {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* Capture Overlay (Shutter Effect) */
        #shutter-flash {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: #fff;
            opacity: 0;
            pointer-events: none;
            z-index: 50;
        }

        .flash-active {
            animation: flash-anim 0.25s ease-out;
        }

        @keyframes flash-anim {
            0% { opacity: 1; }
            100% { opacity: 0; }
        }

        /* Metadata Overlay UI (Live View) */
        #meta-info {
            position: absolute;
            bottom: 20px;
            left: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            padding: 14px;
            border-radius: 16px;
            font-size: 0.8rem;
            border: 1px solid rgba(0, 0, 0, 0.05);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            pointer-events: none;
            transition: opacity 0.3s;
        }

        .meta-line {
            display: flex;
            align-items: center;
            margin-bottom: 6px;
            color: var(--text-color);
            font-weight: 500;
        }

        .meta-line:last-child { margin-bottom: 0; }

        .meta-line i {
            width: 22px;
            color: var(--primary-color);
            font-size: 0.9rem;
        }

        /* Action Bar */
        #action-bar {
            height: calc(100px + var(--safe-area-inset-bottom));
            padding-bottom: var(--safe-area-inset-bottom);
            background-color: var(--bg-color);
            display: flex;
            align-items: center;
            justify-content: space-around;
            padding-left: 25px;
            padding-right: 25px;
            border-top: 1px solid var(--border-color);
            z-index: 100;
        }

        .btn {
            background: #f3f4f6;
            border: 1px solid var(--border-color);
            color: var(--text-color);
            padding: 15px;
            border-radius: 50%;
            width: 54px;
            height: 54px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .btn:active {
            transform: scale(0.9);
            background: #e5e7eb;
        }

        .btn-capture {
            width: 72px;
            height: 72px;
            background: var(--primary-color);
            color: #fff;
            border: none;
            box-shadow: 0 4px 14px rgba(37, 99, 235, 0.4);
        }

        .btn-capture:active {
            background: #1d4ed8;
            box-shadow: 0 2px 6px rgba(37, 99, 235, 0.4);
        }

        .btn-download {
            background: var(--accent-color);
            border: none;
            color: white;
            border-radius: 14px;
            width: auto;
            aspect-ratio: auto;
            padding: 0 24px;
            height: 50px;
            font-weight: 600;
            font-size: 0.9rem;
            gap: 10px;
            box-shadow: 0 4px 12px rgba(5, 150, 105, 0.3);
        }

        .btn-download:active {
            background: #047857;
        }

        .btn:disabled {
            opacity: 0.3;
            filter: grayscale(1);
            box-shadow: none;
        }

        /* Modals & Loading */
        #overlay-screen {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg-color);
            z-index: 200;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px;
            text-align: center;
            display: none;
        }

        .spinner {
            width: 44px;
            height: 44px;
            border: 4px solid #f3f4f6;
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-bottom: 24px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Hidden Canvas */
        #processor-canvas {
            display: none;
        }

        /* Orientation Warning */
        @media (orientation: landscape) {
            #portrait-lock {
                display: flex !important;
            }
        }

        #portrait-lock {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg-color);
            z-index: 9999;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            text-align: center;
        }
    </style>
</head>
<body oncontextmenu="return false;">

    <div id="portrait-lock">
        <i class="fas fa-mobile-alt" style="font-size: 3.5rem; margin-bottom: 20px; color: var(--primary-color);"></i>
        <h2 style="font-weight: 700;">Portrait Recommended</h2>
        <p style="color: #666;">Please hold your phone upright for the best capture experience.</p>
    </div>

    <header>
        <h1>GeoCam Pro</h1>
    </header>

    <main id="app-container">
        <div id="camera-wrapper">
            <video id="camera-preview" autoplay playsinline muted></video>
            <div id="shutter-flash"></div>
            
            <!-- Live Info Overlay -->
            <div id="meta-info">
                <div class="meta-line">
                    <i class="fas fa-location-arrow"></i>
                    <span id="ui-coords">Initializing GPS...</span>
                </div>
                <div class="meta-line">
                    <i class="fas fa-bullseye"></i>
                    <span id="ui-accuracy">Precision: --</span>
                </div>
                <div class="meta-line">
                    <i class="fas fa-map-marked-alt"></i>
                    <span id="ui-place">Determining location...</span>
                </div>
            </div>
        </div>

        <div id="action-bar">
            <button class="btn" id="btn-refresh" title="Reset Session">
                <i class="fas fa-sync-alt"></i>
            </button>
            <button class="btn btn-capture" id="btn-capture" title="Take Photo">
                <i class="fas fa-camera"></i>
            </button>
            <button class="btn btn-download" id="btn-download" disabled>
                <i class="fas fa-cloud-download-alt"></i> Save
            </button>
        </div>

        <!-- System Message Overlay -->
        <div id="overlay-screen">
            <div id="overlay-content">
                <div class="spinner"></div>
                <p id="overlay-msg" style="font-weight: 500;">Securing permissions...</p>
                <button class="btn btn-download" id="btn-retry" style="display:none; margin-top:20px; margin-inline: auto;">Restart App</button>
            </div>
        </div>
    </main>

    <canvas id="processor-canvas"></canvas>

    <script>
        /**
         * GEOCAM PRO ENGINE
         * Optimized for High Accuracy and White Theme UX
         */
        const App = {
            video: document.getElementById('camera-preview'),
            canvas: document.getElementById('processor-canvas'),
            ctx: null,
            btnCapture: document.getElementById('btn-capture'),
            btnDownload: document.getElementById('btn-download'),
            btnRefresh: document.getElementById('btn-refresh'),
            overlay: document.getElementById('overlay-screen'),
            overlayMsg: document.getElementById('overlay-msg'),
            flash: document.getElementById('shutter-flash'),
            
            state: {
                stream: null,
                capturedBlob: null,
                isProcessing: false,
                telemetry: {
                    lat: 0,
                    lng: 0,
                    acc: 0,
                    place: "Locating...",
                    time: ""
                }
            },

            async init() {
                this.ctx = this.canvas.getContext('2d');
                this.bindEvents();
                await this.runStartup();
            },

            bindEvents() {
                this.btnCapture.addEventListener('click', () => this.capture());
                this.btnDownload.addEventListener('click', () => this.download());
                this.btnRefresh.addEventListener('click', () => window.location.reload());
                document.getElementById('btn-retry').addEventListener('click', () => window.location.reload());
                
                // Block zoom/scrolling
                window.addEventListener('touchstart', (e) => {
                    if (e.touches.length > 1) e.preventDefault();
                }, { passive: false });
                
                document.addEventListener('touchmove', (e) => {
                    if (!e.target.closest('#app-container')) e.preventDefault();
                }, { passive: false });
            },

            showError(msg) {
                this.overlay.style.display = 'flex';
                this.overlayMsg.innerHTML = `<span style="color:#dc2626; font-weight:600;">System Error</span><br><small>${msg}</small>`;
                document.querySelector('.spinner').style.display = 'none';
                document.getElementById('btn-retry').style.display = 'inline-flex';
            },

            async runStartup() {
                try {
                    this.updateOverlay("Requesting GPS...");
                    await this.fetchLocation();
                    
                    this.updateOverlay("Initializing Camera...");
                    await this.initCamera();

                    this.overlay.style.display = 'none';
                } catch (err) {
                    console.error(err);
                    this.showError(err.message || "Permissions required to function.");
                }
            },

            updateOverlay(msg) {
                this.overlay.style.display = 'flex';
                this.overlayMsg.innerText = msg;
            },

            async fetchLocation() {
                return new Promise((resolve, reject) => {
                    if (!navigator.geolocation) return reject(new Error("Device lacks GPS hardware"));

                    const geoOptions = { 
                        enableHighAccuracy: true, 
                        timeout: 12000, 
                        maximumAge: 0 
                    };

                    navigator.geolocation.getCurrentPosition(
                        (pos) => {
                            this.state.telemetry.lat = pos.coords.latitude.toFixed(6);
                            this.state.telemetry.lng = pos.coords.longitude.toFixed(6);
                            this.state.telemetry.acc = Math.round(pos.coords.accuracy);
                            
                            document.getElementById('ui-coords').innerText = `${this.state.telemetry.lat}, ${this.state.telemetry.lng}`;
                            document.getElementById('ui-accuracy').innerText = `Precision: Â±${this.state.telemetry.acc}m`;
                            
                            // Mocking Area Names (In production, replace with a Reverse Geocoding API call)
                            this.state.telemetry.place = "Operational Zone Area"; 
                            document.getElementById('ui-place').innerText = this.state.telemetry.place;
                            
                            resolve();
                        },
                        (err) => reject(new Error("Please enable Location Services in your browser settings.")),
                        geoOptions
                    );
                });
            },

            async initCamera() {
                const constraints = {
                    video: {
                        facingMode: { ideal: "environment" },
                        width: { ideal: 3840 }, // Attempt 4K
                        height: { ideal: 2160 }
                    },
                    audio: false
                };

                try {
                    this.state.stream = await navigator.mediaDevices.getUserMedia(constraints);
                    this.video.srcObject = this.state.stream;
                    
                    // Wait for metadata to be ready to ensure correct proportions
                    this.video.onloadedmetadata = () => {
                        this.video.play();
                    };
                } catch (err) {
                    throw new Error("Unable to access camera. Check device permissions.");
                }
            },

            async capture() {
                if (this.state.isProcessing || !this.video.videoWidth) return;
                this.state.isProcessing = true;

                // Visual Shutter Effect
                this.flash.classList.add('flash-active');
                setTimeout(() => this.flash.classList.remove('flash-active'), 250);

                // Set internal processing resolution
                const w = this.video.videoWidth;
                const h = this.video.videoHeight;
                this.canvas.width = w;
                this.canvas.height = h;

                // 1. Snapshot
                this.ctx.drawImage(this.video, 0, 0, w, h);

                // 2. Telemetry Prep
                const now = new Date();
                this.state.telemetry.time = now.toLocaleString('en-US', { 
                    year: 'numeric', month: 'short', day: 'numeric', 
                    hour: '2-digit', minute: '2-digit', second: '2-digit' 
                });
                
                // 3. Watermarking
                this.drawWatermark(w, h);

                // 4. Export
                this.canvas.toBlob((blob) => {
                    this.state.capturedBlob = blob;
                    this.btnDownload.disabled = false;
                    this.state.isProcessing = false;
                }, 'image/jpeg', 0.95);
            },

            drawWatermark(w, h) {
                const margin = w * 0.05;
                const fontSize = Math.max(h * 0.024, 22);
                const barHeight = fontSize * 5;

                // Draw Background Protection (Dark gradient ensures readability on any light/white image)
                const grad = this.ctx.createLinearGradient(0, h - barHeight - margin, 0, h);
                grad.addColorStop(0, 'rgba(0,0,0,0)');
                grad.addColorStop(0.2, 'rgba(0,0,0,0.6)');
                grad.addColorStop(1, 'rgba(0,0,0,0.8)');
                
                this.ctx.fillStyle = grad;
                this.ctx.fillRect(0, h - barHeight - margin, w, barHeight + margin);

                // Render Text
                this.ctx.fillStyle = "#FFFFFF";
                this.ctx.shadowColor = "rgba(0,0,0,0.5)";
                this.ctx.shadowBlur = 4;
                this.ctx.textAlign = "left";
                
                // Line 1: Location Name
                this.ctx.font = `bold ${fontSize}px sans-serif`;
                this.ctx.fillText(`ðŸ“ ${this.state.telemetry.place}`, margin, h - (fontSize * 3.2) - margin);

                // Line 2: Coordinates
                this.ctx.font = `${fontSize * 0.8}px monospace`;
                this.ctx.fillText(`LAT: ${this.state.telemetry.lat}  LNG: ${this.state.telemetry.lng} (Â±${this.state.telemetry.acc}m)`, margin, h - (fontSize * 1.8) - margin);

                // Line 3: Time
                this.ctx.font = `${fontSize * 0.75}px sans-serif`;
                this.ctx.fillStyle = "rgba(255,255,255,0.9)";
                this.ctx.fillText(`ðŸ“… ${this.state.telemetry.time}`, margin, h - margin);

                // Branding
                this.ctx.textAlign = "right";
                this.ctx.font = `italic bold ${fontSize * 0.7}px sans-serif`;
                this.ctx.fillText("GEOCAM PRO â€¢ WEB", w - margin, h - margin);
            },

            download() {
                if (!this.state.capturedBlob) return;

                const stamp = new Date().toISOString().slice(0, 19).replace(/[-:]/g, "").replace("T", "_");
                const fname = `GeoPhoto_${stamp}.jpg`;
                
                const url = URL.createObjectURL(this.state.capturedBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = fname;
                document.body.appendChild(link);
                link.click();
                
                // Cleanup
                setTimeout(() => {
                    document.body.removeChild(link);
                    window.URL.revokeObjectURL(url);
                }, 200);
            }
        };

        // Initialize on load
        window.addEventListener('load', () => App.init());
    </script>
</body>
</html>
